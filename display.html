<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tambola Display</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="wrap">
    
    <div class="card">
      <div class="banner">
        <div>
          <p class="bannerTitle">Welcome 2026 ðŸŽ‰</p>
          <p class="bannerSub">Resolution #1: Donâ€™t cheat in Tambola. Resolution #2: If you do, at least do it confidently ðŸ˜„</p>
        </div>
        <div class="tm">Akash &amp; Arpitaâ„¢</div>
      </div>
      <p class="sub" style="margin-top:10px;">Public screen. It updates only when the host confirms a number.</p>
    </div>

    <div class="displayRow">
      <div class="card">
        <div class="big">
          <div class="bigNum" id="bigNum">â€”</div>
          <div class="kv">
            <span class="pill" id="remainingPill">90 remaining</span>
            <span class="pill" id="countPill">0 called</span>
            <span class="pill" id="updatedPill">Updated: â€”</span>
          </div>
          <div class="lastSeq" id="last5">Last 5: â€”</div>
        </div>

        <div class="panel" style="margin-top:12px;">
          <button id="fullBtn" class="primary">Fullscreen</button>
          <button id="copyBtn">Copy Called List</button>
        </div>
        <div class="status" id="statusLine">Ready.</div>
      </div>

      <div class="card">
        <div class="gridCardTitleRow">
          <div>
            <h1>Called grid (1â€“90)</h1>
            <p class="sub">Green = called â€¢ Yellow outline = most recent</p>
          </div>
          <span class="pill" id="last10Pill">Last 10: â€”</span>
        </div>
        <div class="grid90 bigGrid" id="grid"></div>
      </div>
    </div>


</div>

<script type="module">
  import { loadState, subscribe } from "./state.js";

  const bigNum = document.getElementById("bigNum");
  const grid = document.getElementById("grid");
  const remainingPill = document.getElementById("remainingPill");
  const countPill = document.getElementById("countPill");
  const updatedPill = document.getElementById("updatedPill");
  const last5 = document.getElementById("last5");
  const last10Pill = document.getElementById("last10Pill");
  const statusLine = document.getElementById("statusLine");
  const fullBtn = document.getElementById("fullBtn");
  const copyBtn = document.getElementById("copyBtn");

  const cells = new Map();
  function buildGrid(){
    grid.innerHTML = "";
    for(let n=1;n<=90;n++){
      const d=document.createElement("div");
      d.className="cell";
      d.textContent=n;
      grid.appendChild(d);
      cells.set(n,d);
    }
  }
  buildGrid();

  function fmtTime(iso){
    if(!iso) return "â€”";
    try{
      const d = new Date(iso);
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }catch(e){ return "â€”"; }
  }

  function render(state){
    // reset
    for(const el of cells.values()) el.classList.remove("called","lastCalled");

    // apply called
    for(const n of state.called){
      cells.get(n)?.classList.add("called");
    }
    // last outline
    if(state.last) cells.get(state.last)?.classList.add("lastCalled");

    bigNum.textContent = state.last ?? "â€”";
    remainingPill.textContent = `${90 - state.called.length} remaining`;
    countPill.textContent = `${state.called.length} called`;
    updatedPill.textContent = `Updated: ${fmtTime(state.updatedAt)}`;
    const seq = state.called.slice(-5).join(", ") || "â€”";
    last5.textContent = `Last 5: ${seq}`;
    const last10 = state.called.slice(-10).join(", ") || "â€”";
    if(last10Pill) last10Pill.textContent = `Last 10: ${last10}`;
    statusLine.textContent = state.last ? `Last confirmed: ${state.last}` : "Waiting for hostâ€¦";
  }

  async function copyCalledList(state){
    const text = state.called.join(", ");
    try{
      await navigator.clipboard.writeText(text);
      statusLine.textContent = `Copied called list (${state.called.length} numbers).`;
    }catch(e){
      statusLine.textContent = "Copy failed. Try manually selecting from host screen.";
    }
  }

  let state = loadState();
  render(state);

  // subscribe to host updates
  subscribe((msg)=>{
    const s = msg?.state;
    if(s){
      state = s;
      render(state);
    }
  });

  fullBtn.addEventListener("click", async ()=>{
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  copyBtn.addEventListener("click", ()=>copyCalledList(state));
</script>
</body>
</html>
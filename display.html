<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tambola Display</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="wrap">
    
    <div class="card">
      <div class="banner">
        <div>
          <p class="bannerTitle">Welcome 2026 ðŸŽ‰</p>
          <p class="bannerSub">New Year. New luck. Same competitive friends ðŸ˜„</p>
          <p class="sub" id="jokeLine" style="margin-top:8px;">â€”</p>
        </div>
        <div class="tm">Akash &amp; Arpita</div>
      </div>
      <p class="sub" style="margin-top:10px;">Public screen. It updates only when the host confirms a number.</p>
    </div>

    <div class="displayRow">
      <div class="card">
        <div class="big">
          <div class="bigNum" id="bigNum">â€”</div>
          <div class="kv">
            <span class="pill" id="remainingPill">90 remaining</span>
            <span class="pill" id="countPill">0 called</span>
            <span class="pill" id="updatedPill">Updated: â€”</span>
          </div>
          <div class="lastSeq" id="last5">Last 5: â€”</div>
        </div>

        <div class="panel" style="margin-top:12px;">
          <button id="fullBtn" class="primary">Fullscreen</button>
          <button id="copyBtn">Copy Called List</button>
        </div>
        <div class="status" id="statusLine">Ready.</div>
      </div>

      <div class="card">
        <div class="gridCardTitleRow">
          <div>
            <h1>Called grid (1â€“90)</h1>
            <p class="sub">Green = called â€¢ Yellow outline = most recent</p>
          </div>
          <span class="pill" id="last10Pill">Last 10: â€”</span>
        </div>
        <div class="grid90 bigGrid" id="grid"></div>
      </div>
    </div>


</div>

<script type="module">
  import { loadState, subscribe } from "./state.js";

  const bigNum = document.getElementById("bigNum");
  const grid = document.getElementById("grid");
  const remainingPill = document.getElementById("remainingPill");
  const countPill = document.getElementById("countPill");
  const updatedPill = document.getElementById("updatedPill");
  const last5 = document.getElementById("last5");
  const last10Pill = document.getElementById("last10Pill");
  const statusLine = document.getElementById("statusLine");
  const jokeLine = document.getElementById("jokeLine");
  const fullBtn = document.getElementById("fullBtn");
  const copyBtn = document.getElementById("copyBtn");

  const cells = new Map();
  function buildGrid(){
    grid.innerHTML = "";
    for(let n=1;n<=90;n++){
      const d=document.createElement("div");
      d.className="cell";
      d.textContent=n;
      grid.appendChild(d);
      cells.set(n,d);
    }
  }
  buildGrid();

  const JOKES = ["2026 goal: win Tambola without bribing the host. Let\u2019s see how long that lasts.", "If you shout \u201cFULL HOUSE\u201d early, you\u2019re buying the next round. House rules.", "Reminder: whispering numbers to your spouse counts as \u201cstrategic consulting.\u201d", "If your ticket is empty, it\u2019s not the universe \u2014 it\u2019s just math.", "Yes, you can manifest a number. No, you can\u2019t manifest a re-roll.", "Tonight\u2019s workout: tapping numbers and jumping up to claim prizes.", "Tambola tip: confidence is 50% of claiming. Accuracy is\u2026 optional.", "If you\u2019re unlucky, just blame Mercury retrograde. Works every time.", "2026 forecast: high chances of drama at \u201cCorners\u201d and \u201cFirst Row.\u201d", "Pro tip: the louder you say a number, the more it feels like it was called.", "If you miss a call, just say \u201clag\u201d \u2014 works for both Wi\u2011Fi and life.", "I\u2019m not competitive\u2026 I just really enjoy winning.", "If your strategy is \u2018stare harder\u2019, respect. Also: good luck.", "Claim responsibly. Side effects may include smugness and snacks.", "New Year, new chances\u2026 same friends yelling at the host \ud83d\ude04"];
  function pickJoke(calledCount){
    // change joke after every 3 published numbers
    const idx = Math.floor(calledCount / 3) % JOKES.length;
    return JOKES[idx];
  }


  function fmtTime(iso){
    if(!iso) return "â€”";
    try{
      const d = new Date(iso);
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    }catch(e){ return "â€”"; }
  }

  function render(state){
    // reset
    for(const el of cells.values()) el.classList.remove("called","lastCalled");

    // apply called
    for(const n of state.called){
      cells.get(n)?.classList.add("called");
    }
    // last outline
    if(state.last) cells.get(state.last)?.classList.add("lastCalled");

    bigNum.textContent = state.last ?? "â€”";
    remainingPill.textContent = `${90 - state.called.length} remaining`;
    countPill.textContent = `${state.called.length} called`;
    updatedPill.textContent = `Updated: ${fmtTime(state.updatedAt)}`;
    const seq = state.called.slice(-5).join(", ") || "â€”";
    last5.textContent = `Last 5: ${seq}`;
    const last10 = state.called.slice(-10).join(", ") || "â€”";
    if(last10Pill) last10Pill.textContent = `Last 10: ${last10}`;
    statusLine.textContent = state.last ? `Last confirmed: ${state.last}` : "Waiting for hostâ€¦";
    if(jokeLine){ jokeLine.textContent = pickJoke(state.called.length); }

  }

  async function copyCalledList(state){
    const text = state.called.join(", ");
    try{
      await navigator.clipboard.writeText(text);
      statusLine.textContent = `Copied called list (${state.called.length} numbers).`;
    }catch(e){
      statusLine.textContent = "Copy failed. Try manually selecting from host screen.";
    }
  }

  let state = loadState();
  render(state);

  // subscribe to host updates
  subscribe((msg)=>{
    const s = msg?.state;
    if(s){
      state = s;
      render(state);
    }
  });

  fullBtn.addEventListener("click", async ()=>{
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  copyBtn.addEventListener("click", ()=>copyCalledList(state));
</script>
</body>
</html>